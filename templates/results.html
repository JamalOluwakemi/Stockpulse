<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockPulse Results</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='jamal/css/bootstrap.min.css') }}">
  <style>
    body { padding-top: 70px; background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .table-container { max-height: 400px; overflow-y: auto; margin-top: 20px; }
    .card { margin-bottom: 30px; border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .card-title { font-weight: 600; color: #343a40; }
    .btn-success, .btn-primary, .btn-back { border-radius: 50px; padding: 8px 20px; font-weight: 500; }
    .btn-back { background-color: #6c757d; color: white; margin-right: 10px; }
    table.data { width: 100%; border-collapse: collapse; }
    table.data th, table.data td { padding: 8px 12px; text-align: center; }
    table.data tr:nth-child(even) { background-color: #f8f9fa; }
    table.data tr th { background-color: #343a40; color: white; position: sticky; top: 0; }
    .anomaly { background-color: #ffcccc !important; font-weight: bold; }
    #chart-card { display: none; margin-top: 20px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">StockPulse</a>
  </div>
</nav>

<div class="container">

  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="card-title">Anomaly Detection Table</h4>
      <div class="table-container">
        <table class="data table table-striped">
          <thead>
            <tr>{% for col in columns %}<th>{{ col }}</th>{% endfor %}</tr>
          </thead>
          <tbody>
            {% for row in tables[0] %}
            <tr class="{% if row.get('Anomaly', 0) == 1 %}anomaly{% endif %}">
              {% for col in columns %}
                <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-back">&larr; Back</a>
        <a href="{{ url_for('download_report', filename=report_file) }}" class="btn btn-success">Download Anomaly Report (CSV)</a>
        {% if 'Date' in columns and 'Close' in columns %}
          <button class="btn btn-primary" id="toggle-chart-btn">Generate Chart</button>
        {% endif %}
      </div>
    </div>
  </div>

  {% if not has_anomalies %}
  <div class="alert alert-info mt-3">
    âœ… No anomalies detected in this dataset.
  </div>
  {% endif %}

  <div class="card shadow-sm" id="chart-card">
    <div class="card-body">
      <h4 class="card-title">Stock Price Chart with Anomalies</h4>
      <iframe id="chart-iframe" style="width:100%; height:500px; border:none;"></iframe>
      <div class="mt-3 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-back">&larr; Back to Home</a>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='jamal/js/bootstrap.bundle.min.js') }}"></script>
<script>
  const plotFile = "{{ plot_file if plot_file else '' }}";
  const toggleBtn = document.getElementById('toggle-chart-btn');
  const chartCard = document.getElementById('chart-card');
  const chartIframe = document.getElementById('chart-iframe');

  toggleBtn?.addEventListener('click', function() {
      if (!plotFile) {
          alert("Cannot generate chart: CSV missing 'Date' or 'Close'.");
          return;
      }
      if (chartCard.style.display === "none") {
          chartIframe.src = "/plot/" + plotFile;
          chartCard.style.display = "block";
          toggleBtn.textContent = "Hide Chart";
          chartCard.scrollIntoView({ behavior: 'smooth' });
      } else {
          chartCard.style.display = "none";
          toggleBtn.textContent = "Generate Chart";
      }
  });
</script>

</body>
</html>
